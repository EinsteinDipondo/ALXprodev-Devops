#!/bin/bash

# apiAutomation-0x00
# Automates API requests to the Pokémon API for Pikachu

# Variables
API_URL="https://pokeapi.co/api/v2/pokemon/pikachu"
OUTPUT_FILE="data.json"
ERROR_FILE="errors.txt"

# Function to log errors
log_error() {
    local error_message="$1"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $error_message" >> "$ERROR_FILE"
}

# Function to make API request
make_api_request() {
    # Make the API request with curl
    # -s: silent mode (no progress meter)
    # -S: show error if it fails (combined with -s)
    # -w: write HTTP status code to stdout
    # -o: output to file
    # --max-time: maximum time for request (10 seconds)
    # --retry: retry up to 2 times on failure
    
    local http_code
    local curl_output
    
    # Make the request and capture both output and HTTP status code
    curl_output=$(curl -sS \
        --max-time 10 \
        --retry 2 \
        -w "%{http_code}" \
        -o "$OUTPUT_FILE.tmp" \
        "$API_URL")
    
    # Extract HTTP status code (last 3 characters)
    http_code="${curl_output: -3}"
    
    # Check if curl command succeeded
    if [[ $? -ne 0 ]]; then
        log_error "Curl command failed to execute properly"
        return 1
    fi
    
    # Check HTTP status code
    if [[ "$http_code" == "200" ]]; then
        # Success - move temp file to final file
        mv "$OUTPUT_FILE.tmp" "$OUTPUT_FILE"
        echo "Successfully retrieved Pikachu data to $OUTPUT_FILE"
        return 0
    else
        # Log error based on HTTP status code
        case "$http_code" in
            404)
                error_msg="Pokémon not found (HTTP 404)"
                ;;
            429)
                error_msg="Rate limit exceeded (HTTP 429)"
                ;;
            500|502|503|504)
                error_msg="Server error (HTTP $http_code)"
                ;;
            *)
                error_msg="HTTP request failed with code: $http_code"
                ;;
        esac
        
        log_error "$error_msg"
        echo "Error: $error_msg - Check $ERROR_FILE for details"
        
        # Remove temp file on error
        rm -f "$OUTPUT_FILE.tmp"
        return 1
    fi
}

# Function to validate JSON
validate_json() {
    if [[ -f "$OUTPUT_FILE" ]]; then
        if jq empty "$OUTPUT_FILE" 2>/dev/null; then
            echo "JSON validation: ✓ Valid JSON structure"
            return 0
        else
            log_error "Invalid JSON received from API"
            echo "Error: Invalid JSON received - Check $ERROR_FILE"
            return 1
        fi
    fi
    return 1
}

# Function to display sample output
display_sample() {
    if [[ -f "$OUTPUT_FILE" ]]; then
        echo "Sample output (first 50 lines):"
        echo "========================================="
        jq . < "$OUTPUT_FILE" | head -n 50
        echo "========================================="
    fi
}

# Main script execution
main() {
    echo "Starting Pokémon API Automation..."
    echo "Target: Pikachu"
    echo "API URL: $API_URL"
    echo "Output file: $OUTPUT_FILE"
    echo "Error log: $ERROR_FILE"
    echo "-----------------------------------------"
    
    # Clear previous error file
    > "$ERROR_FILE"
    
    # Make API request
    if make_api_request; then
        echo "✓ API request successful"
        
        # Validate JSON
        if validate_json; then
            echo "✓ JSON validation passed"
            echo "-----------------------------------------"
            
            # Display sample output
            display_sample
            
            # Show file info
            echo -e "\nFile created: $OUTPUT_FILE"
            echo "File size: $(wc -c < "$OUTPUT_FILE") bytes"
            
            # Show success message
            echo -e "\n✅ Automation completed successfully!"
        else
            echo "✗ JSON validation failed"
            exit 1
        fi
    else
        echo "✗ API request failed"
        exit 1
    fi
}

# Run main function
main

# Exit with appropriate code
exit 0
