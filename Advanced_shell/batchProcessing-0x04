#!/bin/bash

# batchProcessing-0x04 - Simple version with kill

# Configuration
POKEMON=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")
OUT_DIR="pokemon_parallel"
MAX_JOBS=2
API="https://pokeapi.co/api/v2/pokemon"

# Setup
mkdir -p "$OUT_DIR"
echo "Parallel Pokémon Fetch"
echo "======================"

# Array for process IDs
declare -a PIDS

# Function using kill to manage processes
manage_processes() {
    local current_pids=("$@")
    local new_pids=()
    
    for pid in "${current_pids[@]}"; do
        # Use kill -0 to check if process is still alive
        if kill -0 "$pid" 2>/dev/null; then
            new_pids+=("$pid")
        else
            # Process finished, wait for it
            wait "$pid"
            echo "  Process $pid finished"
        fi
    done
    
    echo "${new_pids[@]}"
}

# Start fetching
echo "Starting parallel fetch..."
index=0

while [[ $index -lt ${#POKEMON[@]} ]]; do
    # Check current active processes
    active_count=${#PIDS[@]}
    
    if [[ $active_count -lt $MAX_JOBS ]]; then
        # Start new process
        name="${POKEMON[$index]}"
        
        # Start fetch in background
        (
            echo "  Starting $name..."
            if curl -s --max-time 30 "$API/$name" -o "$OUT_DIR/${name}.json" 2>/dev/null; then
                echo "  ✅ $name completed"
            else
                echo "  ❌ $name failed"
                rm -f "$OUT_DIR/${name}.json"
            fi
        ) &
        
        pid=$!
        PIDS+=("$pid")
        echo "  Launched PID $pid for $name"
        
        ((index++))
    else
        # Wait for a process to finish using kill check
        echo "  Max jobs reached ($MAX_JOBS), checking processes..."
        
        # Update PIDS array (remove finished processes)
        PIDS=($(manage_processes "${PIDS[@]}"))
        
        sleep 1
    fi
done

# Wait for all remaining processes using kill
echo ""
echo "All Pokémon started. Waiting for completion..."

while [[ ${#PIDS[@]} -gt 0 ]]; do
    echo "  Still waiting for ${#PIDS[@]} processes..."
    
    # Use kill to check each process
    for i in "${!PIDS[@]}"; do
        pid=${PIDS[$i]}
        
        # kill -0 checks if process exists
        if ! kill -0 "$pid" 2>/dev/null; then
            # Process finished, wait for it
            wait "$pid"
            echo "    PID $pid finished"
            unset PIDS[$i]
        fi
    done
    
    # Re-index array
    PIDS=("${PIDS[@]}")
    
    if [[ ${#PIDS[@]} -gt 0 ]]; then
        sleep 2
    fi
done

# Final check with kill
echo ""
echo "Final verification using kill -0..."
for pid in "${PIDS[@]}"; do
    if kill -0 "$pid" 2>/dev/null 2>&1; then
        echo "  PID $pid still running (unexpected)"
        wait "$pid"
    fi
done

echo ""
echo "======================"
echo "Fetch complete!"
echo "Files in: $OUT_DIR"
ls "$OUT_DIR"/*.json 2>/dev/null | wc -l | xargs echo "Files created:"
