#!/bin/bash

# summaryData-0x03
# Summarize Pokémon data and generate CSV report

# Variables
INPUT_DIR="pokemon_data"
REPORT_FILE="pokemon_report.csv"

# Check if pokemon_data directory exists
if [[ ! -d "$INPUT_DIR" ]]; then
    echo "Error: Directory '$INPUT_DIR' not found." >&2
    echo "Please run ./batchProcessing-0x02 first to generate Pokémon data." >&2
    exit 1
fi

# Check if there are JSON files
if ! ls "$INPUT_DIR"/*.json >/dev/null 2>&1; then
    echo "Error: No JSON files found in '$INPUT_DIR'" >&2
    exit 1
fi

echo "Generating Pokémon report..."

# Create CSV header
echo "Name,Height (m),Weight (kg)" > "$REPORT_FILE"

# Temporary file for storing extracted data
TEMP_FILE=$(mktemp)

# Extract data from each JSON file
for json_file in "$INPUT_DIR"/*.json; do
    if [[ -f "$json_file" ]]; then
        # Extract name, height, weight
        # Note: API returns height in decimetres and weight in hectograms
        # Convert to meters (÷10) and kilograms (÷10)
        if data=$(jq -r '
            .name + "," + 
            (.height/10|tostring) + "," + 
            (.weight/10|tostring)
        ' "$json_file" 2>/dev/null); then
            echo "$data" >> "$TEMP_FILE"
        fi
    fi
done

# Check if we got any data
if [[ ! -s "$TEMP_FILE" ]]; then
    echo "Error: Could not extract data from JSON files" >&2
    rm -f "$TEMP_FILE"
    exit 1
fi

# Sort data by Pokémon name (alphabetically)
# Capitalize first letter of each name
awk -F',' '{
    # Capitalize first letter of name
    $1 = toupper(substr($1,1,1)) substr($1,2)
    print $0
}' "$TEMP_FILE" | sort -t, -k1 >> "$REPORT_FILE"

# Calculate averages using awk
echo ""
echo "CSV Report generated at: $REPORT_FILE"
echo ""
# Display the CSV content
cat "$REPORT_FILE"

# Calculate and display averages
echo ""
awk -F',' '
NR == 1 { next }  # Skip header
{
    height_sum += $2
    weight_sum += $3
    count++
}
END {
    if (count > 0) {
        avg_height = height_sum / count
        avg_weight = weight_sum / count
        printf "Average Height: %.2f m\n", avg_height
        printf "Average Weight: %.2f kg\n", avg_weight
    } else {
        print "No data to calculate averages"
    }
}' "$REPORT_FILE"

# Cleanup
rm -f "$TEMP_FILE"

exit 0
